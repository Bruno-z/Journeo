@if (loading()) {
  <div class="loading-container">
    <span class="spinner spinner--dark" aria-label="Chargement du guide"></span>
    Chargement…
  </div>
} @else if (error()) {
  <div class="alert alert--error" role="alert">{{ error() }}</div>
} @else if (guide()) {
  <div class="detail">
    <!-- Header -->
    <div class="page-header">
      <div class="detail__title-row">
        <a routerLink="/dashboard/guides" class="back-link" aria-label="Retour aux guides">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M19 12H5m0 0l7 7m-7-7l7-7"/>
          </svg>
        </a>
        <h1 class="page-header__title">{{ guide()!.titre }}</h1>
      </div>
      @if (auth.isAdmin()) {
        <div class="page-header__actions">
          <a routerLink="/dashboard/guides/{{ guide()!.id }}/edit" class="btn btn--secondary">
            Modifier
          </a>
          <button class="btn btn--danger" (click)="delete()" [disabled]="deleting()">
            @if (deleting()) { <span class="spinner" aria-hidden="true"></span> }
            Supprimer
          </button>
        </div>
      }
    </div>

    <!-- Info card -->
    <div class="card detail__info-card">
      <div class="card__body">
        <div class="info-grid">
          <div class="info-item">
            <dt class="info-item__label">Durée</dt>
            <dd class="info-item__value">{{ guide()!.jours }} jour{{ guide()!.jours > 1 ? 's' : '' }}</dd>
          </div>
          <div class="info-item">
            <dt class="info-item__label">Mobilité</dt>
            <dd class="info-item__value">{{ mobiliteLabels[guide()!.mobilite] }}</dd>
          </div>
          <div class="info-item">
            <dt class="info-item__label">Saison</dt>
            <dd class="info-item__value">{{ saisonLabels[guide()!.saison] }}</dd>
          </div>
          <div class="info-item">
            <dt class="info-item__label">Public</dt>
            <dd class="info-item__value">{{ publicCibleLabels[guide()!.pourQui] }}</dd>
          </div>
        </div>

        @if (guide()!.description) {
          <p class="detail__description">{{ guide()!.description }}</p>
        }
      </div>
    </div>

    <!-- Activities -->
    <section class="detail__section" aria-labelledby="activities-heading">
      <div class="detail__section-header">
        <h2 id="activities-heading" class="detail__section-title">
          Programme
          <span class="badge badge--neutral">{{ guide()!.activities?.length ?? 0 }} activité{{ (guide()!.activities?.length ?? 0) !== 1 ? 's' : '' }}</span>
        </h2>
        @if (auth.isAdmin()) {
          <button class="btn btn--primary btn--sm" (click)="showActivityForm.set(!showActivityForm())">
            @if (showActivityForm()) { Annuler } @else { + Ajouter }
          </button>
        }
      </div>

      @if (auth.isAdmin() && showActivityForm()) {
        <div class="card activity-form-card">
          <div class="card__header"><h3 class="card__title">Nouvelle activité</h3></div>
          <div class="card__body">
            @if (activityError()) {
              <div class="alert alert--error" role="alert">{{ activityError() }}</div>
            }
            <form [formGroup]="activityForm" (ngSubmit)="submitActivity()" class="activity-form">
              <div class="activity-form__row">
                <div class="form-group">
                  <label class="form-label" for="act-titre">Titre *</label>
                  <input id="act-titre" class="form-input" formControlName="titre" placeholder="Ex: Visite du Louvre" />
                </div>
                <div class="form-group">
                  <label class="form-label" for="act-type">Type *</label>
                  <select id="act-type" class="form-select" formControlName="type">
                    <option value="MUSEE">Musée</option>
                    <option value="CHATEAU">Château</option>
                    <option value="ACTIVITE">Activité</option>
                    <option value="PARC">Parc</option>
                    <option value="GROTTE">Grotte</option>
                  </select>
                </div>
              </div>
              <div class="activity-form__row activity-form__row--three">
                <div class="form-group">
                  <label class="form-label" for="act-jour">Jour *</label>
                  <input id="act-jour" type="number" class="form-input" formControlName="jour" min="1" />
                </div>
                <div class="form-group">
                  <label class="form-label" for="act-ordre">Ordre *</label>
                  <input id="act-ordre" type="number" class="form-input" formControlName="ordre" min="1" />
                </div>
                <div class="form-group">
                  <label class="form-label" for="act-duree">Durée (min) *</label>
                  <input id="act-duree" type="number" class="form-input" formControlName="duree" min="1" />
                </div>
              </div>
              <div class="activity-form__row">
                <div class="form-group">
                  <label class="form-label" for="act-heure">Heure de début</label>
                  <input id="act-heure" type="time" class="form-input" formControlName="heureDebut" />
                </div>
                <div class="form-group">
                  <label class="form-label" for="act-adresse">Adresse</label>
                  <input id="act-adresse" class="form-input" formControlName="adresse" placeholder="Ex: Rue de Rivoli, Paris" />
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="act-desc">Description</label>
                <textarea id="act-desc" class="form-textarea" formControlName="description" rows="2" placeholder="Description optionnelle…"></textarea>
              </div>
              <div class="activity-form__actions">
                <button type="submit" class="btn btn--primary" [disabled]="activitySaving()">
                  @if (activitySaving()) { <span class="spinner" aria-hidden="true"></span> }
                  Créer l'activité
                </button>
              </div>
            </form>
          </div>
        </div>
      }

      @if (!guide()!.activities?.length) {
        <div class="empty-state">
          <p class="empty-state__title">Aucune activité programmée</p>
        </div>
      } @else {
        <div class="days-list">
          @for (day of daysArray(); track day) {
            <div class="day-block">
              <h3 class="day-block__title">Jour {{ day }}</h3>
              <div class="activities-list">
                @for (activity of activitiesByDay().get(day)!; track activity.id) {
                  <div class="activity-item">
                    <div class="activity-item__time">
                      @if (activity.heureDebut) {
                        <span>{{ activity.heureDebut }}</span>
                      } @else {
                        <span class="text-muted">—</span>
                      }
                    </div>
                    <div class="activity-item__body">
                      <div class="activity-item__header">
                        <h4 class="activity-item__title">{{ activity.titre }}</h4>
                        <span class="badge badge--primary">{{ activityTypeLabels[activity.type] }}</span>
                        @if (auth.isAdmin()) {
                          <button
                            class="btn btn--danger btn--sm"
                            (click)="deleteActivity(activity.id)"
                            [disabled]="deletingActivity() === activity.id"
                            [attr.aria-label]="'Supprimer ' + activity.titre"
                          >
                            @if (deletingActivity() === activity.id) { <span class="spinner" aria-hidden="true"></span> } @else { × }
                          </button>
                        }
                      </div>
                      @if (activity.description) {
                        <p class="activity-item__desc">{{ activity.description }}</p>
                      }
                      <div class="activity-item__meta">
                        @if (activity.adresse) {
                          <span class="activity-meta-item">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                              <circle cx="12" cy="10" r="3"/>
                            </svg>
                            {{ activity.adresse }}
                          </span>
                        }
                        @if (activity.duree) {
                          <span class="activity-meta-item">{{ activity.duree }} min</span>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </section>

    <!-- Assigned users (ADMIN only) -->
    @if (auth.isAdmin()) {
      <section class="detail__section" aria-labelledby="users-heading">
        <h2 id="users-heading" class="detail__section-title">
          Utilisateurs assignés
          <span class="badge badge--neutral">{{ guide()!.users?.length ?? 0 }}</span>
        </h2>

        @if (guide()!.users?.length) {
          <div class="users-list">
            @for (user of guide()!.users!; track user.id) {
              <div class="user-item">
                <div class="user-item__avatar" aria-hidden="true">{{ user.email[0].toUpperCase() }}</div>
                <div class="user-item__info">
                  <span class="user-item__email">{{ user.email }}</span>
                  <span class="badge badge--neutral">{{ user.role }}</span>
                </div>
                <button class="btn btn--ghost btn--sm" (click)="removeUser(user.id)" [attr.aria-label]="'Retirer ' + user.email">
                  Retirer
                </button>
              </div>
            }
          </div>
        }

        @if (unassignedUsers().length) {
          <div class="assign-section">
            <p class="assign-section__label">Assigner un utilisateur :</p>
            <div class="assign-list">
              @for (user of unassignedUsers(); track user.id) {
                <button class="assign-btn" (click)="addUser(user.id)" [attr.aria-label]="'Assigner ' + user.email">
                  <div class="user-item__avatar user-item__avatar--sm" aria-hidden="true">{{ user.email[0].toUpperCase() }}</div>
                  {{ user.email }}
                </button>
              }
            </div>
          </div>
        }
      </section>
    }
  </div>
}
