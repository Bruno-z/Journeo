<form class="wizard"
      [formGroup]="form"
      (ngSubmit)="submit()"
      [class.wizard--forward]="animDir() === 'forward'"
      [class.wizard--back]="animDir() === 'back'">

  <!-- â”€â”€ Topbar fixe : Annuler + barre de progression + compteur â”€â”€ -->
  <div class="wizard__topbar">
    <button class="wizard__cancel" type="button" (click)="cancel()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
        <path d="M19 12H5m0 0l7 7m-7-7l7-7"/>
      </svg>
      Annuler
    </button>

    <div class="wizard__progress-track"
         role="progressbar"
         [attr.aria-valuenow]="currentStep()"
         aria-valuemin="1"
         aria-valuemax="5">
      <div class="wizard__progress-fill"
           [style.width.%]="(currentStep() / 5) * 100"></div>
    </div>

    <span class="wizard__counter">{{ currentStep() }} / 5</span>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 1 â€” Titre
       Fond : cover Wikipedia floutÃ© + overlay sombre
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (currentStep() === 1) {
    <div class="wizard__step wizard__step--cover"
         [style.--cover-url]="'url(' + coverPreview() + ')'">

      <p class="step-label">Ã‰tape 1 / 5</p>
      <h2 class="step-question step-question--light">
        {{ isEdit() ? 'Modifiez le titre de votre guide' : 'Commencez par nommer votre guide' }}
      </h2>

      <input
        class="cover-input"
        type="text"
        formControlName="titre"
        placeholder="Ex : Week-end romantique Ã  Rome"
        autocomplete="off"
        autofocus
      >

      @if (form.get('titre')?.invalid && form.get('titre')?.touched) {
        <span class="cover-error">Le titre doit faire au moins 2 caractÃ¨res.</span>
      }

      <div class="step-nav">
        <button type="button" class="btn-next btn-next--light" (click)="goNext()">
          {{ isEdit() ? 'Suivant' : 'Commencer' }}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <path d="M5 12h14m-7-7 7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 2 â€” Saison
       4 grandes cartes visuelles â€” clic = sÃ©lection + avance
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (currentStep() === 2) {
    <div class="wizard__step">
      <p class="step-label">Ã‰tape 2 / 5</p>
      <h2 class="step-question">Quelle est la saison idÃ©ale ?</h2>

      <div class="season-grid">
        @for (key of saisons; track key) {
          <button
            type="button"
            class="season-card"
            [class.season-card--active]="form.value.saison === key"
            (click)="setVal('saison', key); goNext()"
          >
            <span class="season-card__icon">
              @if (key === 'ETE')        { â˜€ï¸ }
              @else if (key === 'HIVER')      { â„ï¸ }
              @else if (key === 'PRINTEMPS')  { ğŸŒ¸ }
              @else                           { ğŸ‚ }
            </span>
            <span class="season-card__label">{{ saisonLabels[key] }}</span>
          </button>
        }
      </div>

      <div class="step-nav step-nav--back-only">
        <button type="button" class="btn-back" (click)="goBack()">â† Retour</button>
      </div>
    </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 3 â€” MobilitÃ© + Pour qui
       2 colonnes de tuiles cÃ´te Ã  cÃ´te
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (currentStep() === 3) {
    <div class="wizard__step">
      <p class="step-label">Ã‰tape 3 / 5</p>
      <h2 class="step-question">Comment voyager, et avec qui ?</h2>

      <div class="two-col-tiles">
        <div class="tile-group">
          <h3 class="tile-group__label">Mode de transport</h3>
          <div class="tiles-list">
            @for (key of mobilites; track key) {
              <button
                type="button"
                class="tile tile--sm"
                [class.tile--active]="form.value.mobilite === key"
                (click)="setVal('mobilite', key)"
              >
                <span class="tile__icon">
                  @if (key === 'A_PIED')  { ğŸš¶ }
                  @else if (key === 'VELO')    { ğŸš² }
                  @else if (key === 'VOITURE') { ğŸš— }
                  @else                        { ğŸšŒ }
                </span>
                <span class="tile__label">{{ mobiliteLabels[key] }}</span>
              </button>
            }
          </div>
        </div>

        <div class="tile-group">
          <h3 class="tile-group__label">Pour qui ?</h3>
          <div class="tiles-list">
            @for (key of cibles; track key) {
              <button
                type="button"
                class="tile tile--sm"
                [class.tile--active]="form.value.pourQui === key"
                (click)="setVal('pourQui', key)"
              >
                <span class="tile__icon">
                  @if (key === 'FAMILLE')     { ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ }
                  @else if (key === 'COUPLE')      { ğŸ’‘ }
                  @else if (key === 'ENTRE_AMIS')  { ğŸ‘¯ }
                  @else                             { ğŸ’ }
                </span>
                <span class="tile__label">{{ publicCibleLabels[key] }}</span>
              </button>
            }
          </div>
        </div>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" (click)="goBack()">â† Retour</button>
        <button type="button" class="btn-next" (click)="goNext()">
          Suivant
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <path d="M5 12h14m-7-7 7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 4 â€” DurÃ©e
       Chiffre gÃ©ant + boutons âˆ’ / +
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (currentStep() === 4) {
    <div class="wizard__step">
      <p class="step-label">Ã‰tape 4 / 5</p>
      <h2 class="step-question">Combien de jours dure ce voyage ?</h2>

      <div class="duration-picker">
        <button
          type="button"
          class="duration-btn"
          (click)="adjustJours(-1)"
          [disabled]="(form.value.jours ?? 1) <= 1"
          aria-label="Diminuer"
        >âˆ’</button>

        <div class="duration-display">
          <span class="duration-number">{{ form.value.jours }}</span>
          <span class="duration-unit">jour{{ (form.value.jours ?? 1) > 1 ? 's' : '' }}</span>
        </div>

        <button
          type="button"
          class="duration-btn"
          (click)="adjustJours(1)"
          [disabled]="(form.value.jours ?? 1) >= 30"
          aria-label="Augmenter"
        >+</button>
      </div>

      <div class="step-nav">
        <button type="button" class="btn-back" (click)="goBack()">â† Retour</button>
        <button type="button" class="btn-next" (click)="goNext()">
          Suivant
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <path d="M5 12h14m-7-7 7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       STEP 5 â€” Description + RÃ©sumÃ© + Publier
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  @if (currentStep() === 5) {
    <div class="wizard__step wizard__step--summary">
      <p class="step-label">Ã‰tape 5 / 5 â€” DerniÃ¨re Ã©tape !</p>
      <h2 class="step-question">Ajoutez une description <span class="step-optional">(optionnel)</span></h2>

      <textarea
        class="summary-textarea"
        rows="3"
        formControlName="description"
        placeholder="Donnez envie aux voyageurs en quelques mots..."
      ></textarea>

      <!-- AperÃ§u de la carte guide -->
      <div class="summary-preview">
        <div class="guide-card-preview">
          <div class="card-image">
            <img [src]="coverPreview()" alt="AperÃ§u de la cover" class="img-cover">
            <div class="card-overlay"></div>
            @if (form.value.saison) {
              <span class="badge-saison">{{ saisonLabels[form.value.saison!] }}</span>
            }
          </div>
          <div class="card-content">
            <h3 class="card-title">{{ form.value.titre || 'Titre du voyage...' }}</h3>
            <div class="card-tags">
              @if (form.value.mobilite) {
                <span class="tag tag--blue">{{ mobiliteLabels[form.value.mobilite!] }}</span>
              }
              @if (form.value.pourQui) {
                <span class="tag tag--green">{{ publicCibleLabels[form.value.pourQui!] }}</span>
              }
              @if (form.value.jours) {
                <span class="tag tag--orange">{{ form.value.jours }}j</span>
              }
            </div>
          </div>
        </div>
      </div>

      @if (error()) {
        <p class="summary-error">{{ error() }}</p>
      }

      <div class="step-nav">
        <button type="button" class="btn-back" (click)="goBack()">â† Retour</button>
        <button type="submit" class="btn-submit" [disabled]="form.invalid || saving() || loading()">
          @if (saving()) { <span class="spinner"></span> }
          {{ isEdit() ? 'Enregistrer les modifications' : 'Publier le guide' }}
        </button>
      </div>
    </div>
  }

</form>
