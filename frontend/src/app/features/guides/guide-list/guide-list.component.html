<style>
  .gl-header__title {
    font-size: 2.5rem;
    font-weight: 800;
    color: #E85A1E;
    letter-spacing: -1px;
  }
  .guide-card__title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1f2937;
  }
  .guide-info__title {
    font-size: 2.25rem;
    font-weight: 800;
    color: #E85A1E;
    line-height: 1.2;
    margin-bottom: 1rem;
  }
  
  /* Nouveau layout pour les activités */
  .activities-preview {
    margin: 3rem 0;
  }
  .activities-preview__header {
    font-size: 1.1rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .activities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1rem;
  }
  .mini-act {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .mini-act:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    border-color: #E85A1E;
  }
  .mini-act__icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff7ed;
    border-radius: 50%;
  }
  .mini-act__content {
    min-width: 0;
  }
  .mini-act__title {
    font-weight: 600;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.95rem;
  }
  .mini-act__meta {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.1rem;
  }
</style>
<!-- Split-screen layout: left 58% + right 42% (Leaflet map) -->
<div class="split">

  <!-- ══════════════════════════════════════════
       LEFT PANEL — Guide list + carousel + info
       ══════════════════════════════════════════ -->
  <div class="split__left">

    <!-- Header -->
    <div class="gl-header">
      <div class="gl-header__top">
        <div>
          <h1 class="gl-header__title">Mes Guides</h1>
          @if (!loading()) {
            <p class="gl-header__count">
              {{ filtered().length }} guide{{ filtered().length !== 1 ? 's' : '' }}
            </p>
          }
        </div>
      </div>

      <!-- Search -->
      <div class="gl-search">
        <svg class="gl-search__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input
          class="gl-search__input"
          type="search"
          placeholder="Rechercher un guide..."
          [value]="search()"
          (input)="updateSearch($any($event.target).value)"
          aria-label="Rechercher"
        />
      </div>
    </div>

    <!-- Loading / Error / Empty -->
    @if (loading()) {
      <div class="gl-state">
        <span class="spinner spinner--dark"></span>
        <span>Chargement…</span>
      </div>
    } @else if (error()) {
      <div class="gl-state gl-state--error">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        {{ error() }}
      </div>
    } @else if (!filtered().length) {
      <div class="gl-state">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
        </svg>
        Aucun guide trouvé
      </div>
    } @else {

      <!-- ── Carousel ── -->
      <div class="carousel">
        <!-- Prev arrow -->
        <button
          class="carousel__arrow carousel__arrow--prev"
          (click)="prevCarousel()"
          [disabled]="!canPrev()"
          aria-label="Page précédente"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>

        <!-- Cards -->
        <div class="carousel__track">
          @for (guide of visibleGuides(); track guide.id) {
            <div
              class="guide-card"
              [class.guide-card--active]="guide.id === activeGuide()?.id"
              (click)="selectGuide(guide)"
              role="button"
              [attr.aria-pressed]="guide.id === activeGuide()?.id"
              [attr.aria-label]="guide.titre"
            >
              <!-- Cover image -->
              <div class="guide-card__img-wrap">
                <img
                  class="guide-card__img"
                  [src]="coverFor(guide)"
                  [alt]="guide.titre"
                  loading="lazy"
                />
                <div class="guide-card__overlay"></div>
                @if (guide.saison) {
                  <span class="guide-card__season-badge">{{ saisonLabels[guide.saison] }}</span>
                }
              </div>

              <!-- Card body -->
              <div class="guide-card__body">
                <h3 class="guide-card__title">{{ guide.titre }}</h3>
                <div class="guide-card__chips">
                  @if (guide.mobilite) {
                    <span class="chip chip--blue">{{ mobiliteLabels[guide.mobilite] }}</span>
                  }
                  @if (guide.pourQui) {
                    <span class="chip chip--green">{{ publicCibleLabels[guide.pourQui] }}</span>
                  }
                  @if (guide.jours) {
                    <span class="chip chip--orange">{{ guide.jours }}j</span>
                  }
                </div>

                <!-- Footer actions -->
                <div class="guide-card__footer">
                  <a
                    [routerLink]="['/dashboard/guides', guide.id]"
                    class="btn btn--secondary btn--sm"
                    (click)="$event.stopPropagation()"
                  >Voir →</a>

                  @if (auth.isAdmin()) {
                    <div class="guide-card__admin">
                      <a
                        [routerLink]="['/dashboard/guides', guide.id, 'edit']"
                        class="btn btn--ghost btn--sm"
                        (click)="$event.stopPropagation()"
                        aria-label="Modifier"
                      >
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                      </a>
                      <button
                        class="btn btn--danger btn--sm"
                        (click)="delete(guide); $event.stopPropagation()"
                        [disabled]="deleting() === guide.id"
                        aria-label="Supprimer"
                      >
                        @if (deleting() === guide.id) {
                          <span class="spinner"></span>
                        } @else {
                          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                        }
                      </button>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Next arrow -->
        <button
          class="carousel__arrow carousel__arrow--next"
          (click)="nextCarousel()"
          [disabled]="!canNext()"
          aria-label="Page suivante"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>

      <!-- Carousel pagination dots -->
      @if (carouselPages().length > 1) {
        <div class="carousel__dots" aria-label="Pages">
          @for (page of carouselPages(); track page) {
            <button
              class="carousel__dot"
              [class.carousel__dot--active]="page === currentPage()"
              (click)="goToPage(page)"
              [attr.aria-label]="'Page ' + (page + 1)"
            ></button>
          }
        </div>
      }

      <!-- ── Active guide info ── -->
      @if (activeGuide(); as guide) {
        <div class="guide-info">
          <div class="guide-info__chips">
            @if (guide.saison) {
              <span class="chip chip--orange">{{ saisonLabels[guide.saison] ?? guide.saison }}</span>
            }
            @if (guide.mobilite) {
              <span class="chip chip--blue">{{ mobiliteLabels[guide.mobilite] ?? guide.mobilite }}</span>
            }
            @if (guide.pourQui) {
              <span class="chip chip--green">{{ publicCibleLabels[guide.pourQui] ?? guide.pourQui }}</span>
            }
            @if (guide.jours) {
              <span class="chip chip--neutral">{{ guide.jours }} jour{{ guide.jours > 1 ? 's' : '' }}</span>
            }
          </div>
          <h2 class="guide-info__title">{{ guide.titre }}</h2>
          @if (guide.description) {
            <p class="guide-info__desc">{{ guide.description }}</p>
          }

        @if (guide.activities && guide.activities.length > 0) {
          <div class="activities-preview">
            <h3 class="activities-preview__header">
              Programme du voyage
              <span class="badge badge--neutral">{{ guide.activities.length }}</span>
            </h3>
            <div class="activities-grid">
              @for (act of guide.activities; track act.id) {
                <div class="mini-act">
                  <div class="mini-act__icon">{{ getActivityIcon(act.type) }}</div>
                  <div class="mini-act__content">
                    <div class="mini-act__title" [title]="act.titre">{{ act.titre }}</div>
                    <div class="mini-act__meta">
                      {{ act.type }} @if(act.duree){ • {{ act.duree }} min }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        </div>

        <!-- ── Comments ── -->
        <div class="comments-wrap">

          <!-- Compose card -->
          <div class="compose-card">
            <div class="compose-card__rating-row" role="group" aria-label="Note sur 5">
              <span class="compose-card__rating-label">Votre note</span>
              @for (star of starsArray(); track star) {
                <button
                  type="button"
                  class="cstar"
                  [class.cstar--active]="star <= newRating()"
                  (click)="newRating.set(star)"
                  [attr.aria-label]="star + ' étoile' + (star > 1 ? 's' : '')"
                >★</button>
              }
              <span class="compose-card__rating-val">{{ newRating() }}/5</span>
            </div>

            <textarea
              class="compose-card__textarea"
              rows="4"
              placeholder="Ajouter un commentaire..."
              [value]="newComment()"
              (input)="newComment.set($any($event.target).value)"
            ></textarea>

            <div class="compose-card__toolbar">
              <div class="compose-card__tools" aria-hidden="true">
                <button type="button" class="tool-btn tool-btn--bold" tabindex="-1">B</button>
                <button type="button" class="tool-btn tool-btn--italic" tabindex="-1">I</button>
                <button type="button" class="tool-btn tool-btn--underline" tabindex="-1">U</button>
                <span class="tool-sep"></span>
                <button type="button" class="tool-btn" tabindex="-1">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                </button>
                <button type="button" class="tool-btn" tabindex="-1">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                </button>
                <button type="button" class="tool-btn" tabindex="-1">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </button>
                <button type="button" class="tool-btn" tabindex="-1">
                  <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg>
                </button>
              </div>
              <button
                type="button"
                class="compose-card__submit"
                (click)="submitComment()"
                [disabled]="!newComment().trim() || commentSaving()"
              >
                @if (commentSaving()) { <span class="spinner spinner--sm" aria-hidden="true"></span> }
                Publier
              </button>
            </div>
          </div>

          <!-- Comments header -->
          <div class="comments-header">
            <div class="comments-header__info">
              <h3 class="comments-header__title">Avis</h3>
              @if (comments().length > 0) {
                <span class="comments-header__badge">{{ comments().length }}</span>
              }
            </div>
            <button class="comments-sort" type="button" aria-label="Trier les avis">
              Le plus récent <span class="comments-sort__arrows">↕</span>
            </button>
          </div>

          <!-- Loading skeleton -->
          @if (commentsLoading()) {
            <div class="comments-list">
              @for (i of [1,2]; track i) {
                <div class="comment-item comment-item--skeleton">
                  <div class="skeleton-avatar"></div>
                  <div class="comment-item__body">
                    <div class="skeleton-line skeleton-line--sm"></div>
                    <div class="skeleton-line skeleton-line--lg" style="margin-top:.5rem"></div>
                  </div>
                </div>
              }
            </div>
          } @else if (comments().length === 0) {
            <div class="empty-comments">
              <p>Aucun avis pour le moment. Soyez le premier !</p>
            </div>
          } @else {
            <div class="comments-list">
              @for (c of comments(); track c.id) {
                <article class="comment-item">
                  <div class="comment-item__avatar" [style.background]="avatarColor(c.authorEmail)" aria-hidden="true">
                    {{ (c.authorFirstName || c.authorEmail)[0].toUpperCase() }}
                  </div>
                  <div class="comment-item__body">
                    <div class="comment-item__top">
                      <span class="comment-item__name">{{ authorName(c) }}</span>
                      <span class="comment-item__time">{{ timeAgo(c.createdAt) }}</span>
                      @if (canDeleteComment(c)) {
                        <button
                          class="comment-item__delete"
                          (click)="deleteComment(c.id)"
                          aria-label="Supprimer l'avis"
                        >×</button>
                      }
                    </div>
                    <p class="comment-item__content">{{ c.content }}</p>
                    <div class="comment-item__actions">
                      <button class="caction" type="button" aria-label="J'aime">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3H14z"/><path d="M7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"/></svg>
                        <span>{{ likeCount(c) }}</span>
                      </button>
                      <button class="caction" type="button" aria-label="Je n'aime pas">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 003 3l4-9V2H5.72a2 2 0 00-2 1.7l-1.38 9a2 2 0 002 2.3H10z"/><path d="M17 2h2.67A2.31 2.31 0 0122 4v7a2.31 2.31 0 01-2.33 2H17"/></svg>
                        <span>{{ dislikeCount(c) }}</span>
                      </button>
                      <button class="caction caction--reply" type="button">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                        Répondre
                      </button>
                    </div>
                  </div>
                </article>
              }
            </div>
          }

        </div>
      }
    }
  </div>

  <!-- Vertical divider with orange glow -->
  <div class="split__divider" aria-hidden="true"></div>

  <!-- ══════════════════════════════════════════
       RIGHT PANEL — Leaflet map full height
       ══════════════════════════════════════════ -->
  <div class="split__right">
    <div #mapEl class="map-container"></div>

    <!-- Floating city badge -->
    @if (activeGuide(); as guide) {
      <div class="map-badge">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        {{ guide.titre }}
      </div>
    }
  </div>

</div>
