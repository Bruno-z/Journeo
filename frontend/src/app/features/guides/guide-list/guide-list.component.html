<style>
  /* ðŸŽ¨ Nouveau Design Compact & Widget MÃ©tÃ©o */
  .guide-detail-container {
    margin-top: 2.5rem;
    animation: fadeIn 0.5s ease-out;
  }

  .guide-header-row {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .guide-content { flex: 1; }

  .guide-title-lg {
    font-size: 2rem;
    font-weight: 800;
    color: #1e293b;
    margin: 0.5rem 0 1rem;
    line-height: 1.1;
  }

  .guide-desc-lg {
    color: #64748b;
    line-height: 1.6;
    font-size: 1rem;
  }

  /* Widget MÃ©tÃ©o */
  .weather-card {
    background: linear-gradient(135deg, #38bdf8, #2563eb);
    color: white;
    padding: 1.5rem;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 140px;
    box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
    text-align: center;
    transition: transform 0.3s;
  }
  .weather-card:hover { transform: translateY(-5px); }
  
  .weather-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
  .weather-temp { font-size: 1.75rem; font-weight: 700; }
  .weather-label { font-size: 0.75rem; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

  /* Commentaires Compacts (Style Chat) */
  .comments-box {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
  }

  .comments-header {
    padding: 1rem 1.5rem;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 700;
    color: #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .comments-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 0;
    margin: 0;
    list-style: none;
  }

  .comment-row {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    gap: 1rem;
    transition: background 0.2s;
  }
  .comment-row:last-child { border-bottom: none; }
  .comment-row:hover { background: #fcfcfc; }

  .comment-avatar-sm {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: #e0f2fe;
    color: #0284c7;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 0.85rem;
    flex-shrink: 0;
  }

  .comment-content { flex: 1; }
  .comment-meta { display: flex; justify-content: space-between; margin-bottom: 0.25rem; align-items: center; }
  .comment-author { font-weight: 600; font-size: 0.9rem; color: #0f172a; }
  .comment-rating { color: #fbbf24; font-size: 0.8rem; letter-spacing: 1px; }
  .comment-text { font-size: 0.9rem; color: #475569; line-height: 1.5; margin: 0; }

  .comment-input-area {
    padding: 1rem;
    border-top: 1px solid #e2e8f0;
    background: #fff;
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .mini-input {
    flex: 1;
    border: 1px solid #cbd5e1;
    border-radius: 99px;
    padding: 0.6rem 1.2rem;
    font-size: 0.9rem;
    transition: all 0.2s;
  }
  .mini-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  
  .send-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #3b82f6;
    color: white;
    border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .send-btn:hover { transform: scale(1.05); background: #2563eb; }
  .send-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<!-- Split-screen layout: left 58% + right 42% (Leaflet map) -->
<div class="split">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LEFT PANEL â€” Guide list + carousel + info
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="split__left">

    <!-- Header -->
    <div class="gl-header">
      <div class="gl-header__top">
        <div>
          <h1 class="gl-header__title">Mes Guides</h1>
          @if (!loading()) {
            <p class="gl-header__count">
              {{ filtered().length }} guide{{ filtered().length !== 1 ? 's' : '' }}
            </p>
          }
        </div>
      </div>

      <!-- Search -->
      <div class="gl-search">
        <svg class="gl-search__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input
          class="gl-search__input"
          type="search"
          placeholder="Rechercher un guide..."
          [value]="search()"
          (input)="updateSearch($any($event.target).value)"
          aria-label="Rechercher"
        />
      </div>
    </div>

    <!-- Loading / Error / Empty -->
    @if (loading()) {
      <div class="gl-state">
        <span class="spinner spinner--dark"></span>
        <span>Chargementâ€¦</span>
      </div>
    } @else if (error()) {
      <div class="gl-state gl-state--error">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
        {{ error() }}
      </div>
    } @else if (!filtered().length) {
      <div class="gl-state">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
        </svg>
        Aucun guide trouvÃ©
      </div>
    } @else {

      <!-- â”€â”€ Carousel â”€â”€ -->
      <div class="carousel">
        <!-- Prev arrow -->
        <button
          class="carousel__arrow carousel__arrow--prev"
          (click)="prevCarousel()"
          [disabled]="!canPrev()"
          aria-label="Page prÃ©cÃ©dente"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
        </button>

        <!-- Cards -->
        <div class="carousel__track">
          @for (guide of visibleGuides(); track guide.id) {
            <div
              class="guide-card"
              [class.guide-card--active]="guide.id === activeGuide()?.id"
              (click)="selectGuide(guide)"
              role="button"
              [attr.aria-pressed]="guide.id === activeGuide()?.id"
              [attr.aria-label]="guide.titre"
            >
              <!-- Cover image -->
              <div class="guide-card__img-wrap">
                <img
                  class="guide-card__img"
                  [src]="coverFor(guide)"
                  [alt]="guide.titre"
                  loading="lazy"
                />
                <div class="guide-card__overlay"></div>
                @if (guide.saison) {
                  <span class="guide-card__season-badge">{{ saisonLabels[guide.saison] ?? guide.saison }}</span>
                }
              </div>

              <!-- Card body -->
              <div class="guide-card__body">
                <h3 class="guide-card__title">{{ guide.titre }}</h3>
                <div class="guide-card__chips">
                  @if (guide.mobilite) {
                    <span class="chip chip--blue">{{ mobiliteLabels[guide.mobilite] ?? guide.mobilite }}</span>
                  }
                  @if (guide.pourQui) {
                    <span class="chip chip--green">{{ publicCibleLabels[guide.pourQui] ?? guide.pourQui }}</span>
                  }
                  @if (guide.jours) {
                    <span class="chip chip--orange">{{ guide.jours }}j</span>
                  }
                </div>

                <!-- Footer actions -->
                <div class="guide-card__footer">
                  <a
                    [routerLink]="['/dashboard/guides', guide.id]"
                    class="btn btn--secondary btn--sm"
                    (click)="$event.stopPropagation()"
                  >Voir â†’</a>

                  @if (auth.isAdmin()) {
                    <div class="guide-card__admin">
                      <a
                        [routerLink]="['/dashboard/guides', guide.id, 'edit']"
                        class="btn btn--ghost btn--sm"
                        (click)="$event.stopPropagation()"
                        aria-label="Modifier"
                      >
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                      </a>
                      <button
                        class="btn btn--danger btn--sm"
                        (click)="delete(guide); $event.stopPropagation()"
                        [disabled]="deleting() === guide.id"
                        aria-label="Supprimer"
                      >
                        @if (deleting() === guide.id) {
                          <span class="spinner"></span>
                        } @else {
                          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
                        }
                      </button>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Next arrow -->
        <button
          class="carousel__arrow carousel__arrow--next"
          (click)="nextCarousel()"
          [disabled]="!canNext()"
          aria-label="Page suivante"
        >
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
        </button>
      </div>

      <!-- Carousel pagination dots -->
      @if (carouselPages().length > 1) {
        <div class="carousel__dots" aria-label="Pages">
          @for (page of carouselPages(); track page) {
            <button
              class="carousel__dot"
              [class.carousel__dot--active]="page === currentPage()"
              (click)="goToPage(page)"
              [attr.aria-label]="'Page ' + (page + 1)"
            ></button>
          }
        </div>
      }

      <!-- â”€â”€ Active guide info â”€â”€ -->
      @if (activeGuide(); as guide) {
        <div class="guide-info">
          <div class="guide-info__chips">
            @if (guide.saison) {
              <span class="chip chip--orange">{{ saisonLabels[guide.saison] ?? guide.saison }}</span>
            }
            @if (guide.mobilite) {
              <span class="chip chip--blue">{{ mobiliteLabels[guide.mobilite] ?? guide.mobilite }}</span>
            }
            @if (guide.pourQui) {
              <span class="chip chip--green">{{ publicCibleLabels[guide.pourQui] ?? guide.pourQui }}</span>
            }
            @if (guide.jours) {
              <span class="chip chip--neutral">{{ guide.jours }} jour{{ guide.jours > 1 ? 's' : '' }}</span>
            }
          </div>
          <h2 class="guide-info__title">{{ guide.titre }}</h2>
          @if (guide.description) {
            <p class="guide-info__desc">{{ guide.description }}</p>
          }
        </div>

        <!-- â”€â”€ Comments â”€â”€ -->
        <div class="comments-modern">
          <h3 class="comments-header-modern comments-title-modern">
            Avis
            <span class="comments-badge">{{ comments().length }} avis</span>
          </h3>

          <!-- New comment form -->
          <div class="comments__form" style="background: white; padding: 1.25rem; border-radius: 16px; border: 1px solid #e2e8f0; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
            <div class="comments__stars" style="margin-bottom: 1rem;">
              @for (star of starsArray(); track star) {
                <button
                  class="star-btn"
                  [class.star-btn--active]="star <= newRating()"
                  (click)="newRating.set(star)"
                  [attr.aria-label]="star + ' Ã©toiles'"
                >â˜…</button>
              }
            </div>
            <textarea
              class="form-textarea comments__textarea"
              placeholder="Partagez votre expÃ©rienceâ€¦"
              rows="3"
              [value]="newComment()"
              (input)="newComment.set($any($event.target).value)"
              style="border: 1px solid #cbd5e1; border-radius: 12px; padding: 0.75rem; width: 100%; margin-bottom: 1rem; resize: vertical; min-height: 80px;"
            ></textarea>
            <button
              class="btn btn--primary btn--sm comments__submit"
              (click)="submitComment()"
              [disabled]="!newComment().trim() || commentSaving()"
              style="width: 100%; justify-content: center; padding: 0.75rem;"
            >
              @if (commentSaving()) {
                <span class="spinner"></span> Envoiâ€¦
              } @else {
                Publier
              }
            </button>
          </div>

          <!-- Comments list -->
          @if (commentsLoading()) {
            <div class="comments__loading">
              <span class="spinner spinner--dark"></span>
            </div>
          } @else if (comments().length === 0) {
            <div class="empty-state" style="padding: 2rem; background: white; border-radius: 16px; border: 1px dashed #cbd5e1;">
              <p class="comments__empty">Aucun avis pour le moment. Soyez le premier !</p>
            </div>
          } @else {
            <div class="comments-feed" role="list">
              @for (c of comments(); track c.id; let i = $index) {
                <article class="comment-card-modern" [style.animation-delay]="i * 100 + 'ms'">
                  <div style="display: flex; align-items: flex-start; gap: 1rem;">
                  <div class="comment-avatar-modern" aria-hidden="true">
                    {{ (c.authorFirstName ?? c.authorEmail)[0].toUpperCase() }}
                  </div>
                  <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                      <span style="font-weight: 700; color: #334155;">
                        {{ c.authorFirstName && c.authorLastName ? (c.authorFirstName + ' ' + c.authorLastName) : c.authorEmail }}
                      </span>
                      <span style="color: #fbbf24; font-size: 0.9rem; letter-spacing: 2px;">
                        @for (s of starsArray(); track s) {
                          <span [style.color]="s <= c.rating ? '#fbbf24' : '#e2e8f0'">â˜…</span>
                        }
                      </span>
                    </div>
                      @if (auth.isAdmin()) {
                        <button
                          class="comment__delete" style="float: right; margin-left: 0.5rem; color: #ef4444; opacity: 0.6;"
                          (click)="deleteComment(c.id)"
                          aria-label="Supprimer l'avis"
                        >âœ•</button>
                      }
                    <p style="color: #475569; line-height: 1.6; font-size: 0.95rem; margin: 0;">{{ c.content }}</p>
                  </div>
                  </div>
                </article>
              }
            </div>
          }
        </div>
      }
    }
  </div>

  <!-- Vertical divider with orange glow -->
  <div class="split__divider" aria-hidden="true"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RIGHT PANEL â€” Leaflet map full height
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="split__right">
    <div #mapEl class="map-container"></div>

    <!-- Floating city badge -->
    @if (activeGuide(); as guide) {
      <div class="map-badge">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
        {{ guide.titre }}
      </div>
    }
  </div>

</div>
